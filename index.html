<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <script type="text/javascript" src="jquery-2.1.4.js"></script>
        <link rel="stylesheet" type="text/css" href="default.css"/>
    </head>
    <body>
        <script language="javascript" src="./lib/sha512.js"></script>
        <script language="javascript" src="./lib/core.js"></script>
        <script language="javascript" src="./lib/plugin_login.js"></script>
        <div style="position: absolute;" id="frame_ui" class="ui">
        </div>
        <div style="visibility: hidden; text-align: center; width: 100%; height: 100%; background-color: rgba(190, 190, 190, 0.5)" id="waitscreen">
        </div>        
        <script language="javascript">
            /*
                This will return the parameters supplied in the
                URL string that was used to access this document.
            */
            function GetURLParameters() {
                var url = window.location.search.substring(1);
                var vars = url.split('&');
                var table = {};

                for (var i = 0; i < vars.length; ++i) {
                    var pair = vars[i].split('=');
                    table[pair[0]] = decodeURI(pair[1]);
                }

                return table;
            }

            function TimeKeeper(frame) {
                var __tk = this;
                this.prefix = frame.id + '__';

                frame.style.margin = '10px';
                frame.style.display = 'inline-block';

                $(frame).append('<span style="display: inline; font-size: 3em; color: #cccccc;">Time Keeper</span> <img style="width: 30px; height: 30px;" src="logo.png"/> <i style="color: #666666; font-size: 0.5em;">version 0.0.1</i><hr/><br/>');

                var menu = document.createElement('div');
                var container = document.createElement('div');

                $(frame).append(menu, '<br/>', container);

                container.style.margin = '10px';
                container.style.display = 'inline-block';

                this.plugins = {
                    'Reports':          plugin_Reports,
                    'Login':            plugin_Login,
                    'Console':          plugin_Console,
                    'Calendar':         plugin_Calendar,
                    'PersonnelManager': plugin_PersonnelManager,
                }


                var default_plugin = 'Login';

                menu.className = 'ui';

                function Version1IF(tk) {
                    this.tk = tk;
                }

                /*
                    This allows the plugin to set information about itself
                    that could not otherwise have been passed by the constr-
                    uctor. Otherwise, the plugin would require a second init
                    function to make usage of its
                */
                Version1IF.prototype.register = function (plugin) {
                    this.plugin = plugin;
                };

                Version1IF.prototype.log = function (msg) {
                    if (this.console == undefined) {
                        this.console = this.getPlugin('Console');
                    }

                    if (this.console != null) {
                        this.console.write('{0}: {1}'.format(this.plugin.name, msg));
                    } 
                }

                Version1IF.prototype.getAuthHash = function () {
                    if (this.getPlugin('Login') == undefined) {
                        return undefined;
                    }

                    return this.getPlugin('Login').getAuthHash();
                }

                Version1IF.prototype.getPlugin = function (name) {
                    if (!(name in this.tk.plugins)) {
                        return null;
                    }
                    return this.tk.plugins[name].object;
                };

                var __plugins = this.plugins;

                for (var k in this.plugins) {
                    var newframe = document.createElement('div');
                    newframe.className = 'ui';
                    newframe.style.display = 'inline-block';
                    if (default_plugin == k) {
                        $(newframe).show();
                        this.plugins[k].visible = true;
                    } else {
                        $(newframe).hide();
                        this.plugins[k].visible = false;
                    }
                    /*
                        The constructor for the plugin is executed. The
                        plugin must be careful and only perform quick
                        critical initialization of important structures.
                    */
                    var iface = new Version1IF(this);
                    this.plugins[k] = {
                        'object':          new this.plugins[k](iface, newframe), 
                        'frame':           newframe,
                        'iface':           iface,
                    };
                    /*
                        The interface needs a reference to the plugin and
                        we had to wait to give it to it.
                    */
                    iface.register(this.plugins[k].object);

                    $(container).append(newframe);
                    var menubtn = document.createElement('input');
                    menubtn.type = 'submit';
                    menubtn.value = k;
                    menubtn.className = 'ui';
                    menubtn.pluginName = k;
                    menubtn.onclick = function () {
                        var v;
                        for (var k in __plugins) {
                            if (k == this.pluginName) {
                                if (!__plugins[k].visible) {
                                    if ('onshow' in __plugins[k].object) {
                                        __plugins[k].object.onshow();
                                    }
                                }
                                $(__plugins[k].frame).show();
                                __plugins[k].visible = true;
                            } else {
                                if (__plugins[k].visible) {
                                    if ('onhide' in __plugins[k].object) {
                                        __plugins[k].object.onhide();
                                    }
                                }
                                $(__plugins[k].frame).hide();
                                __plugins[k].visible = false;
                            }
                        }
                    }
                    $(menu).append(menubtn);
                }

                for (var k in this.plugins) {
                    /*
                        At this point the plugin has full usage of the
                        interface facilities.
                    */
                    this.plugins[k].object.init();
                }                
            }

            var g__tk = new TimeKeeper(frame_ui);

            month_num_to_name = [
                'Error',
                'January', 'Feburary', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November',
                'December'
            ];
        </script>
    </body>
</html>