<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <script type="text/javascript" src="jquery-2.1.4.js"></script>
        <link rel="stylesheet" title="newstyle" type="text/css" href="default.css"/>
        <link rel="stylesheet" type="text/css" href="plugcalendar.css"/>
    </head>
    <body>
        <script language="javascript" src="./lib/sha512.js"></script>
        <script language="javascript" src="./lib/core.js"></script>
        <script language="javascript" src="./lib/plugin_login.js"></script>
        <script language="javascript" src="./lib/plugin_reports.js"></script>
        <script language="javascript" src="./lib/plugin_calendar.js"></script>
        <div style="position: absolute;" id="frame_ui" class="uiframe">
        </div>
        <div style="visibility: hidden; text-align: center; width: 100%; height: 100%; background-color: rgba(190, 190, 190, 0.5)" id="waitscreen">
        </div>        
        <script language="javascript">
            /*
                This will return the parameters supplied in the
                URL string that was used to access this document.
            */
            function getURLParameters() {
                var url = window.location.search.substring(1);
                var vars = url.split('&');
                var table = {};

                for (var i = 0; i < vars.length; ++i) {
                    var pair = vars[i].split('=');
                    table[pair[0]] = decodeURI(pair[1]);
                }

                return table;
            }

            function TimeKeeper(frame, default_plugin, no_menu) {
                var __tk = this;
                this.prefix = frame.id + '__';

                this.urlparameters = getURLParameters();

                if (!no_menu) {
                    $(frame).append('<span style="display: inline; font-size: 3em; color: #cccccc;">Xemo</span> <img style="width: 30px; height: 30px;" src="logo.png"/> <i style="color: #666666; font-size: 0.5em;">version 0.0.1</i><hr/><br/>');
                }

                var menu = document.createElement('div');
                var container = document.createElement('div');

                if (!no_menu) {
                    $(frame).append(menu, '<br/>');
                }

                $(frame).append(container);

                if (!(default_plugin in xemo.plugins)) {
                    default_plugin = 'Login';
                }

                menu.className = 'ui';

                function Version1IF(tk) {
                    this.tk = tk;
                }

                /*
                    This allows the plugin to set information about itself
                    that could not otherwise have been passed by the constr-
                    uctor. Otherwise, the plugin would require a second init
                    function to make usage of its
                */
                Version1IF.prototype.register = function (plugin) {
                    this.plugin = plugin;
                };

                Version1IF.prototype.getURLParameters = function () {
                    return this.tk.urlparameters;
                }

                Version1IF.prototype.log = function (msg) {
                    if (this.console == undefined) {
                        this.console = this.getPlugin('Console');
                    }

                    if (this.console != null) {
                        this.console.write('{0}: {1}'.format(this.plugin.name, msg));
                    } 
                }

                Version1IF.prototype.showPlugin = function (name) {
                    this.tk.showPlugin(name);
                }

                Version1IF.prototype.getAuthHash = function () {
                    if (this.getPlugin('Login') == undefined) {
                        return undefined;
                    }

                    return this.getPlugin('Login').getAuthHash();
                }

                Version1IF.prototype.getPlugin = function (name) {
                    if (!(name in xemo.plugins)) {
                        return null;
                    }
                    return xemo.plugins[name].object;
                };

                for (var k in xemo.plugins) {
                    var newframe = document.createElement('div');
                    newframe.className = 'ui';
                    newframe.style.display = 'inline-block';

                    $(newframe).hide();

                    /*
                        The constructor for the plugin is executed. The
                        plugin must be careful and only perform quick
                        critical initialization of important structures.
                    */
                    var iface = new Version1IF(this);
                    xemo.plugins[k].object = new xemo.plugins[k](iface, newframe);
                    xemo.plugins[k].frame = newframe;
                    xemo.plugins[k].iface = iface;

                    /*
                        The interface needs a reference to the plugin and
                        we had to wait to give it to it.
                    */
                    iface.register(xemo.plugins[k].object);

                    $(container).append(newframe);
                    var menubtn = document.createElement('input');
                    menubtn.type = 'submit';
                    menubtn.value = k;
                    menubtn.className = 'ui';
                    menubtn.pluginName = k;
                    menubtn.tk = this;
                    menubtn.onclick = function () {
                        this.tk.showPlugin(this.pluginName);
                    }
                    $(menu).append(menubtn);
                }

                for (var k in xemo.plugins) {
                    /*
                        At this point the plugin has full usage of the
                        interface facilities.
                    */
                    alert('k: ' + k);
                    xemo.plugins[k].object.init();                    
                }

                for (var k in xemo.plugins) {
                    if (default_plugin == k) {
                        $(xemo.plugins[k].frame).show();
                        xemo.plugins[k].visible = true;
                        if ('onshow' in xemo.plugins[k].object) {
                            xemo.plugins[k].object.onshow();
                        }                        
                    } else {
                        $(xemo.plugins[k].frame).hide();
                        xemo.plugins[k].visible = false;
                    }                    
                }
            }

            TimeKeeper.prototype.showPlugin = function (name) {
                var v;
                for (var k in xemo.plugins) {
                    if (k == name) {
                        if (!xemo.plugins[k].visible) {
                            if ('onshow' in xemo.plugins[k].object) {
                                xemo.plugins[k].object.onshow();
                            }
                        }
                        $(xemo.plugins[k].frame).show();
                        xemo.plugins[k].visible = true;
                    } else {
                        if (xemo.plugins[k].visible) {
                            if ('onhide' in xemo.plugins[k].object) {
                                xemo.plugins[k].object.onhide();
                            }
                        }
                        $(xemo.plugins[k].frame).hide();
                        xemo.plugins[k].visible = false;
                    }
                }                
            }

            var params = getURLParameters();

            if (params.oldstyle == 'true') {
                var links = document.getElementsByTagName('link');
                for (var x = 0; x < links.length; ++x) {
                    var sheet = links[x];
                    if (sheet.title == undefined) {
                        continue;
                    }
                    if (sheet.title == 'newstyle') {
                        sheet.disabled = true;
                    }
                }
            }

            if (params.no_menu == 'true') {
                params.no_menu = true;
            } else {
                params.no_menu = false;
            }

            var g__tk = new TimeKeeper(frame_ui, params.defplug || 'Login', params.no_menu);

            month_num_to_name = [
                'Error',
                'January', 'Feburary', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November',
                'December'
            ];
        </script>
    </body>
</html>